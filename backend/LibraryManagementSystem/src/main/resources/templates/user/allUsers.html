<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>All Users</title>
    <th:block th:insert="~{fragments/head :: head}"></th:block>
</head>
<style>
    .padding {
        padding: 0 8rem;
    }
</style>
<body>
    <th:block th:insert="~{fragments/navigation :: navigation}"></th:block>

    <div class="container-fluid padding">
        <h1 class="display-4 mt-2">Users</h1>

        <div class="table-responsive mt-4">
            <a class="btn btn-success mb-4" sec:authorize="hasAnyAuthority('ADMIN', 'LIBRARIAN')" th:href="@{/users/add}">Add new User</a>
            <table class="table table-hover align-middle">
                <thead class="thead-dark">
                <tr>
                    <th># Id</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>E-Mail</th>
                    <th>Date Of Birth</th>
                    <th>Contact Number</th>
                    <th>Role</th>
                    <th>Loans</th>
                    <th>Actions</th>
                </tr>
                </thead>

                <tbody>
                    <tr th:each="user : ${users}">
                        <th scope="row" th:text="${user.id.toString().substring(0,5)+'...'}"></th>
                        <td th:text="${user.firstName}"></td>
                        <td th:text="${user.lastName}"></td>
                        <td><a th:href="'mailto:' + ${user.email}" th:text="${user.email}"></a></td>
                        <td th:text="${user.dateOfBirth}"></td>
                        <td><a th:href="'tel:' + ${user.contactNumber}" th:text="${user.contactNumber}"></a></td>
                        <td th:each="role : ${user.roles}">
                            <span th:text="${role.name}"></span>
                        </td>
                        <td>
                            <a class="btn btn-primary" role="button" th:href="@{/users/{userId}(userId=${user.id})}"
                               title="User Details"
                            >
                                <i class="bi bi-person-lines-fill"></i>
                            </a>
                            <a class="btn btn-warning" th:href="@{/users/edit/{userId}(userId=${user.id})}"
                               title="Edit User"
                            >
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a class="btn btn-danger btnDelete"
                               role="button"
                               th:href="@{/users/delete/{userId}(userId=${user.id})}"
                               th:if="${currentUserRole == 'ADMIN' && currentUser.get().getEmail() != user.email}"
                               th:userEmail="${user.email}"
                               th:userFirstName="${user.firstName}"
                               th:userLastName="${user.lastName}"
                               title="Delete User"
                            >
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                        <td>
                            <div th:if="${user.roles.stream().findFirst().get().getName() == 'MEMBER'}">
                                <a class="btn btn-dark" role="button"
                                   th:href="@{/loans/{memberId}/current(memberId=${user.id})}"
                                   title="Current Loans"
                                >
                                    Current Loans
                                </a>
                                <a class="btn btn-dark" role="button"
                                   th:href="@{/loans/{memberId}/previous(memberId=${user.id})}"
                                   title="Previous Loans"
                                >
                                    Previous Loans
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>

            </table>
        </div>
    </div>

    <div class="modal py-5" id="deleteModal" role="dialog" tabindex="-1">
        <div class="modal-dialog" role="document">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header border-bottom-0">
                    <h1 class="modal-title fs-5">Confirm Delete</h1>
                </div>
                <div class="modal-body py-0">
                    <p><span id="confirmText"></span></p>
                </div>
                <div class="modal-footer flex-column border-top-0">
                    <a class="btn btn-lg btn-danger w-100 mx-0 mb-2" id="yesBtn" type="button">Delete user</a>
                    <button class="btn btn-lg btn-light w-100 mx-0 noBtn" data-bs-dismiss="modal" type="button">Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
        $(".btnDelete").on("click", function (e) {
            e.preventDefault();
            let href = $(this).attr("href");
            let userEmail = $(this).attr("userEmail");
            let userFirstName = $(this).attr("userFirstName");
            let userLastName = $(this).attr("userLastName");
            $("#confirmText").html("Are you sure you want to delete user: \<b\>" + userFirstName + " " + userLastName + " (" + userEmail + ")\<\/b\>?");
            $('#deleteModal #yesBtn').attr('href', href);
            $("#deleteModal").show();
        });

        $(".noBtn").on("click", function (e) {
            e.preventDefault();
            $("#deleteModal").hide();
        });

</script>
</html>